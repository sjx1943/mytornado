<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>管理员仪表盘 - 待删除商品</title>
    <link rel="stylesheet" href="{{ static_url('css/main.css') }}">
</head>
<body>
    <h1>管理员仪表盘</h1>
    <div class="container">
        <h2>待永久删除的商品</h2>
        <p>以下商品已被用户软删除。在这里可以进行永久物理删除。</p>
        <div class="product-list">
            {% if not products %}
                <p>暂无已删除的商品</p>
            {% else %}
                {% for product in products %}
                    <div class="product-item">
                        <img src="{{ static_url('images/' + product.image) }}" alt="{{ product.name }}" style="width:100px; height:auto;">
                        <div class="product-info">
                            <p><strong>{{ product.name }}</strong> (ID: {{ product.id }})</p>
                            <p>价格: ¥{{ product.price }}</p>
                            <p>所有者ID: {{ product.user_id }}</p>
                        </div>
                        <div class="product-actions">
                            <button class="btn btn-danger physical-delete-btn" data-product-id="{{ product.id }}">永久删除</button>
                        </div>
                    </div>
                {% end %}
            {% end %}
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            document.querySelectorAll('.physical-delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = this.dataset.productId;
                    if (confirm(`您确定要永久删除商品 ID: ${productId} 吗？此操作不可恢复！`)) {
                        fetch(`/api/admin/product/${productId}/physical_delete`, {
                            method: 'POST',
                            headers: { 'X-XSRFToken': getCookie('_xsrf') }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('商品已永久删除');
                                location.reload();
                            } else {
                                alert('删除失败：' + data.error);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    }
                });
            });
        });
    </script>
</body>
</html>
